<!DOCTYPE html>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
        <meta charset="UTF-8">
        <link rel="stylesheet" href="index.css">
        <link rel="stylesheet" href="lunch.css">
        <link rel="stylesheet" href="print.css">
        <title>Оформить заказ - Food Construct</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <header>
            <div class="header-content">
                <nav>
                    <ul>
                        <li><a href="index.html">О нас</a></li>
                        <li><a href="lunch.html">Собрать ланч</a></li>
                        <li><a href="order.html" class="active">Оформить заказ</a></li>
                        <li><a href="orders.html">Заказы</a></li>
                        <li><a href="#contacts">Контакты</a></li>
                        <li><a href="feedback.html">Помощь</a></li>
                    </ul>
                </nav>
                <h1>Food Construct</h1>
            </div>
            <div class="header-right">
                <a href="lk.html" class="login-btn">Войти</a>
                <a href="order.html" class="cart-btn">Корзина</a>
            </div>
        </header>

        <main>
            <h2>Состав заказа</h2>
            <div id="orderComposition" class="dishes-grid"></div>

            <h2>Оформление заказа</h2>
            
            <form method="POST" action="https://httpbin.org/post" id="orderForm">
                <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                    <div style="flex: 1;">
                        <h3>Ваш заказ</h3>
                        <div id="orderSummary" class="order-section"></div>
                    </div>
                    
                    <div style="flex: 1;">
                        <h3>Комментарии к заказу</h3>
                        <textarea name="comment" style="width: 100%; height: 525px; padding: 10px; resize: none;"></textarea>
                    </div>
                </div>

                <h3>Ваши данные</h3>
                
                <input type="text" name="full_name" placeholder="Имя" required style="width: 100%; padding: 10px; margin-bottom: 15px;">
                
                <input type="email" name="email" placeholder="Email" required style="width: 100%; padding: 10px; margin-bottom: 15px;">
                
                <div style="margin-bottom: 15px;">
                    <input type="checkbox" name="subscribe" id="subscribe" value="1">
                    <label for="subscribe">Получать информацию о скидках и акциях</label>
                </div>
                
                <input type="tel" name="phone" placeholder="Номер телефона" required style="width: 100%; padding: 10px; margin-bottom: 15px;">
                
                <textarea name="delivery_address" placeholder="Адрес доставки" required style="width: 100%; padding: 10px; margin-bottom: 15px; height: 60px; resize: none;"></textarea>
                
                <p style="margin-bottom: 15px;"><em>Доставка осуществляется только по Москве</em></p>
                
                <div style="margin-bottom: 20px;">
                    <p style="margin-bottom: 10px;">Время доставки:</p>
                    <input type="radio" name="delivery_type" value="now" id="asap" checked>
                    <label for="asap">Как можно скорее (с 7:00 до 23:00)</label>
                    <input type="radio" name="delivery_type" value="by_time" id="scheduled" style="margin-left: 20px;">
                    <label for="scheduled">К указанному времени</label>
                    <input type="time" name="delivery_time" id="deliveryTime" style="margin-left: 10px; padding: 5px;" min="07:00" max="23:00" step="300" disabled>
                </div>
                <p style="margin-bottom: 15px; font-size: 12px; color: #666;"><em>Доступное время доставки: с 7:00 до 23:00 с шагом 5 минут</em></p>

                <input type="hidden" name="soup_id" id="soupId">
                <input type="hidden" name="main_course_id" id="mainId">
                <input type="hidden" name="salad_id" id="starterId">
                <input type="hidden" name="drink_id" id="drinkId">
                <input type="hidden" name="dessert_id" id="dessertId">
                
                <button type="submit" class="order-button">
                    Отправить
                </button>
            </form>
        </main>

        <footer id="contacts">
            <p>Телефон: +7 (XXX) XXX-XX-XX</p>
            <p>Email: info@foodconstruct.ru</p>
            <p>Адрес: г. Москва, ул. Ленина, д. 1, офис 1</p>
        </footer>

        <script>
            let dishes = [];
            let selectedIds = {};

            async function loadDishes() {
                try {
                    const apiKey = '39715e47-c2dd-439d-8fa6-92ad2fefd448';
                    const response = await fetch(`https://edu.std-900.ist.mospolytech.ru/labs/api/dishes?api_key=${apiKey}`);
                    dishes = await response.json();
                    loadOrder();
                } catch (error) {
                    console.error('Ошибка загрузки:', error);
                    alert('Ошибка загрузки данных');
                }
            }

            function loadOrder() {
                const saved = localStorage.getItem('order');
                if (saved) {
                    selectedIds = JSON.parse(saved);
                }
                displayOrderComposition();
                displayOrderSummary();
            }

            function displayOrderComposition() {
                const container = document.getElementById('orderComposition');
                
                const selectedDishes = [];
                if (selectedIds.soup) {
                    const dish = dishes.find(d => d.id == selectedIds.soup);
                    if (dish) selectedDishes.push({...dish, category: 'soup'});
                }
                if (selectedIds.main) {
                    const dish = dishes.find(d => d.id == selectedIds.main);
                    if (dish) selectedDishes.push({...dish, category: 'main'});
                }
                if (selectedIds.starter) {
                    const dish = dishes.find(d => d.id == selectedIds.starter);
                    if (dish) selectedDishes.push({...dish, category: 'starter'});
                }
                if (selectedIds.drink) {
                    const dish = dishes.find(d => d.id == selectedIds.drink);
                    if (dish) selectedDishes.push({...dish, category: 'drink'});
                }
                if (selectedIds.dessert) {
                    const dish = dishes.find(d => d.id == selectedIds.dessert);
                    if (dish) selectedDishes.push({...dish, category: 'dessert'});
                }

                if (selectedDishes.length === 0) {
                    container.innerHTML = '<p style="text-align: center;">Ничего не выбрано. Чтобы добавить блюда в заказ, перейдите на страницу <a href="lunch.html">Собрать ланч</a>.</p>';
                    container.style.display = 'block';
                    return;
                }

                container.style.display = 'grid';
                container.innerHTML = selectedDishes.map(dish => `
                    <div class="dish-card">
                        <img src="${dish.image}" alt="${dish.name}">
                        <p class="price">${dish.price} ₽</p>
                        <p class="name">${dish.name}</p>
                        <p class="weight">${dish.count}</p>
                        <button type="button" onclick="removeDish('${dish.category}')">Удалить</button>
                    </div>
                `).join('');
            }

            function displayOrderSummary() {
                const container = document.getElementById('orderSummary');
                let total = 0;
                let html = '';

                const categories = {
                    soup: {label: 'Суп', notSelected: 'Не выбран'},
                    main: {label: 'Главное блюдо', notSelected: 'Не выбрано'},
                    starter: {label: 'Салат/стартер', notSelected: 'Не выбран'},
                    drink: {label: 'Напиток', notSelected: 'Не выбран'},
                    dessert: {label: 'Десерт', notSelected: 'Не выбран'}
                };

                Object.keys(categories).forEach(key => {
                    const dish = dishes.find(d => d.id == selectedIds[key]);
                    html += `<div class="order-category"><h3>${categories[key].label}</h3>`;
                    if (dish) {
                        html += `<p>${dish.name} - ${dish.price} ₽</p>`;
                        total += dish.price;
                        document.getElementById(key + 'Id').value = dish.id;
                    } else {
                        html += `<p>${categories[key].notSelected}</p>`;
                    }
                    html += `</div>`;
                });

                html += `<div class="order-total"><h3>Стоимость заказа</h3><p>${total} ₽</p></div>`;
                container.innerHTML = html;
            }

            function removeDish(category) {
                selectedIds[category] = '';
                localStorage.setItem('order', JSON.stringify(selectedIds));
                displayOrderComposition();
                displayOrderSummary();
            }

            function checkCombo() {
                const hasSelection = {
                    soup: !!selectedIds.soup,
                    main: !!selectedIds.main,
                    starter: !!selectedIds.starter,
                    drink: !!selectedIds.drink,
                    dessert: !!selectedIds.dessert
                };
                
                // Точно 5 комбинаций из таблицы (десерт можно добавить к любой)
                const validCombinations = [
                    { soup: true, main: true, starter: true, drink: true },  // Комбо 1
                    { soup: true, main: true, drink: true },                  // Комбо 2
                    { soup: true, starter: true, drink: true },               // Комбо 3
                    { main: true, starter: true, drink: true },               // Комбо 4
                    { main: true, drink: true }                               // Комбо 5
                ];
                
                // Проверяем без десерта
                for (const combo of validCombinations) {
                    let match = true;
                    for (const key of ['soup', 'main', 'starter', 'drink']) {
                        const expected = combo[key] || false;
                        if (expected !== hasSelection[key]) {
                            match = false;
                            break;
                        }
                    }
                    if (match) {
                        return true;
                    }
                }
                
                return false;
            }

            function validateDeliveryTime(time) {
                if (!time) return true;
                
                const [hours, minutes] = time.split(':').map(Number);
                
                if (hours < 7 || hours > 23) {
                    return false;
                }
                
                if (hours === 23 && minutes > 0) {
                    return false;
                }
                
                if (minutes % 5 !== 0) {
                    return false;
                }
                
                return true;
            }

            document.addEventListener('DOMContentLoaded', function() {
                loadDishes();

                document.getElementById('scheduled').addEventListener('change', function() {
                    document.getElementById('deliveryTime').disabled = false;
                    document.getElementById('deliveryTime').required = true;
                });

                document.getElementById('asap').addEventListener('change', function() {
                    document.getElementById('deliveryTime').disabled = true;
                    document.getElementById('deliveryTime').required = false;
                    document.getElementById('deliveryTime').value = '';
                });

                document.getElementById('orderForm').addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const hasItems = Object.values(selectedIds).some(k => k);
                    if (!hasItems) {
                        alert('Выберите хотя бы одно блюдо');
                        return;
                    }

                    if (!checkCombo()) {
                        alert('Состав заказа не соответствует допустимым комбинациям');
                        return;
                    }

                    const deliveryType = document.querySelector('input[name="delivery_type"]:checked').value;
                    const deliveryTime = document.getElementById('deliveryTime').value;
                    
                    if (deliveryType === 'by_time') {
                        if (!deliveryTime) {
                            alert('Укажите время доставки');
                            return;
                        }
                        if (!validateDeliveryTime(deliveryTime)) {
                            alert('Время доставки должно быть в диапазоне с 7:00 до 23:00 с шагом 5 минут');
                            return;
                        }
                    }

                    const formData = new FormData(this);
                    const data = {
                        full_name: formData.get('full_name'),
                        email: formData.get('email'),
                        subscribe: formData.get('subscribe') ? 1 : 0,
                        phone: formData.get('phone'),
                        delivery_address: formData.get('delivery_address'),
                        delivery_type: formData.get('delivery_type'),
                        delivery_time: deliveryType === 'by_time' ? deliveryTime : null,
                        comment: formData.get('comment') || '',
                        soup_id: selectedIds.soup ? parseInt(selectedIds.soup) : null,
                        main_course_id: selectedIds.main ? parseInt(selectedIds.main) : null,
                        salad_id: selectedIds.starter ? parseInt(selectedIds.starter) : null,
                        drink_id: selectedIds.drink ? parseInt(selectedIds.drink) : null,
                        dessert_id: selectedIds.dessert ? parseInt(selectedIds.dessert) : null
                    };

                    // Создаем FormData для обхода CORS
                    const formDataToSend = new FormData();
                    for (const key in data) {
                        if (data[key] !== null && data[key] !== '') {
                            formDataToSend.append(key, data[key]);
                        }
                    }

                    console.log('Отправляемые данные:', Object.fromEntries(formDataToSend));

                    try {
                        const apiKey = '39715e47-c2dd-439d-8fa6-92ad2fefd448';
                        const response = await fetch(`https://edu.std-900.ist.mospolytech.ru/labs/api/orders?api_key=${apiKey}`, {
                            method: 'POST',
                            body: formDataToSend
                        });

                        const result = await response.json();
                        console.log('Ответ сервера:', result);
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Ошибка при оформлении заказа');
                        }

                        console.log('Успешно отправлено:', result);
                        localStorage.removeItem('order');
                        alert('Заказ успешно оформлен!');
                        window.location.href = 'lunch.html';
                    } catch (error) {
                        console.error('Детали ошибки:', error);
                        alert('Ошибка оформления заказа: ' + error.message);
                    }
                });
            });
        </script>
    </body>
</html>